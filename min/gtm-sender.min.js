(function(){"use strict";var x="LA_DATALAYER_EVENT",C="LA_IFRAME_HEIGHT",m="la_"+Date.now()+"_"+Math.random().toString(36).substr(2,9),E=!1,R=5;function o(){E&&console.log.apply(console,["[LA-Bridge Sender]"].concat(Array.prototype.slice.call(arguments)))}function y(){try{return window.self!==window.top}catch{return!0}}function j(e){if(e.event)return e.event;if(e[0]==="event"&&e[1])return e[1];if(e.transactionId||e.transactionTotal)return"purchase";if(e.ecommerce)return"ecommerce";var t=Object.keys(e);return t.length>0&&t.length<=3?t.join("_"):"unknown"}function z(e,t){var r={event:t};if(e[0]==="event"&&e[2]){var n=e[2];return t==="purchase"&&(r.transaction_id=n.transaction_id,r.value=n.value,r.currency=n.currency||"USD"),r}return e.transactionId||e.transactionTotal?(r.transaction_id=e.transactionId,r.value=parseFloat(e.transactionTotal)||0,r.currency="USD",r):Object.assign(r,e)}function u(e){if(y()){var t=j(e);if(!(e[0]==="js"||e[0]==="config")){var r=z(e,t),n={type:x,payload:{eventName:t,data:r,rawData:e,timestamp:Date.now(),url:window.location.href,sessionId:m}};try{window.parent.postMessage(n,"*"),o("Sent event:",n.payload.eventName)}catch(i){o("Failed to send:",i)}}}}var S=0,v=null;function g(){var e=Math.max(document.body.scrollHeight,document.body.offsetHeight,document.documentElement.scrollHeight,document.documentElement.offsetHeight,document.documentElement.clientHeight);if(e=Math.ceil(e)+1,Math.abs(e-S)>R&&e>0){S=e;try{window.parent.postMessage({type:C,height:e,sessionId:m},"*"),o("Sent height:",e)}catch(t){o("Failed to send height:",t)}}}function U(){v&&cancelAnimationFrame(v),v=requestAnimationFrame(function(){v=null,g()})}function D(){if(y()){if(typeof ResizeObserver<"u"){var e=new ResizeObserver(U);e.observe(document.body),e.observe(document.documentElement),o("ResizeObserver installed")}else o("ResizeObserver not available, using fallback"),setInterval(g,500);document.readyState==="complete"?g():window.addEventListener("load",g),o("Height observer setup complete")}}function L(){window.dataLayer=window.dataLayer||[];var e=window.dataLayer.push.bind(window.dataLayer);window.dataLayer.push=function(){var t=Array.prototype.slice.call(arguments);return t.forEach(function(r){r&&typeof r=="object"&&u(r)}),e.apply(window.dataLayer,t)},o("dataLayer interceptor installed"),window.dataLayer.forEach(function(t){t&&typeof t=="object"&&(t.event||t[0]==="event"&&t[1]||t.transactionId||t.transactionTotal)&&u(t)})}function M(){var e=window.dataLayer;Object.defineProperty(window,"dataLayer",{get:function(){return e},set:function(t){o("dataLayer reassignment detected"),e=t,Array.isArray(t)&&L()},configurable:!0})}var f={};function p(e){f[e]&&(f[e].observer.disconnect(),clearTimeout(f[e].timeout),delete f[e])}function B(e){var t=e.key,r=e.selector,n=e.maxWait||1e4,i=e.onFound,a=e.onTimeout;p(t);var c=document.querySelectorAll(r);if(c.length>0){i(c);return}var s=new MutationObserver(function(){var l=document.querySelectorAll(r);l.length>0&&(p(t),i(l))});s.observe(document.body,{childList:!0,subtree:!0});var d=setTimeout(function(){p(t),a&&a()},n);f[t]={observer:s,timeout:d}}var P=!1;function h(e){if(!e||!window.crypto||!window.crypto.subtle)return Promise.resolve(null);var t=new TextEncoder().encode(e);return window.crypto.subtle.digest("SHA-256",t).then(function(r){return Array.from(new Uint8Array(r)).map(function(n){return n.toString(16).padStart(2,"0")}).join("")}).catch(function(){return null})}function G(e){if(!e)return null;if(e=e.trim().toLowerCase(),e.endsWith("@gmail.com")||e.endsWith("@googlemail.com")){var t=e.split("@");e=t[0].replace(/\./g,"")+"@"+t[1]}return e}function T(e){if(!e)return null;var t=e.replace(/\D/g,"");return t.length===10&&(t="1"+t),t.length>=10?"+"+t:null}function I(e){return e?e.trim().toLowerCase():null}function A(){var e={};try{var t=document.querySelector("#Passenger_Email"),r=document.querySelector("#Passenger_Phone"),n=document.querySelector("#Passenger_Phone_View"),i=document.querySelector("#Passenger_FirstName"),a=document.querySelector("#Passenger_LastName");t&&t.value&&(e.email=G(t.value)),r&&r.value?e.phone=T(r.value):n&&n.value&&(e.phone=T(n.value)),i&&i.value&&(e.first_name=I(i.value)),a&&a.value&&(e.last_name=I(a.value))}catch(c){o("Error collecting user data:",c)}return e}function w(e){var t=A(),r={},n=0,i=0;function a(){i===n&&e(Object.keys(r).length>0?r:null)}t.email&&(n++,h(t.email).then(function(c){c&&(r.sha256_email_address=c),i++,a()})),t.phone&&(n++,h(t.phone).then(function(c){c&&(r.sha256_phone_number=c),i++,a()})),t.first_name&&(n++,h(t.first_name).then(function(c){c&&(r.sha256_first_name=c),i++,a()})),t.last_name&&(n++,h(t.last_name).then(function(c){c&&(r.sha256_last_name=c),i++,a()})),n===0&&e(null)}function k(){if(!P){var e=A();!e.email&&!e.phone||(P=!0,o("Ecommerce: add_contact_info captured"),w(function(t){u({event:"add_contact_info",user_data:t})}))}}var _=null,F=!1;function b(){var e={};try{var t=document.querySelector("#ServiceTypeId");t&&t.selectedIndex>=0&&(e.service_type=t.options[t.selectedIndex].text);var r=document.querySelector("#PickupLocation");r&&(e.pickup=r.value);var n=document.querySelector("#DropoffLocation");n&&(e.dropoff=n.value);var i=document.querySelector("#PickUpDate");i&&(e.date=i.value);var a=document.querySelector("#PickUpTime");a&&(e.time=a.value)}catch{}return e}function V(e){return e&&parseFloat(e.replace(/[^0-9.]/g,""))||0}function H(e){if(!e)return null;try{var t=e.querySelector(".vehicle-grid-item-title, .vehicle-grid-item-heading, h2, h4, h5"),r=e.querySelector(".vehicle-grid-item-price"),n=t?t.textContent.trim():"Vehicle",i=V(r?r.textContent:"0"),a=n.toLowerCase().replace(/[^a-z0-9]+/g,"_").replace(/^_|_$/g,"");return{item_id:a||"vehicle",item_name:n,item_category:"Vehicle",price:i,quantity:1}}catch{return null}}function N(){var e=[];try{var t=document.querySelectorAll("#step2RateSection .vehicle-grid-item");t.forEach(function(r,n){var i=H(r);i&&(i.index=n,e.push(i))})}catch{}return e}function W(e){var t={items:[],currency:"USD"};try{var r=e.closest(".vehicle-grid-item"),n=H(r);n&&(t.items.push(n),t.value=n.price,_=n)}catch{}return t}function q(){var e={currency:"USD",items:[]};return _&&(e.items.push(_),e.value=_.price),e}function Y(){document.addEventListener("click",function(n){var i=n.target;(i.matches("#showRatesBtn")||i.closest("#showRatesBtn"))&&(o("Ecommerce: view_item_list requested, waiting for vehicles..."),B({key:"view_item_list",selector:"#step2RateSection .vehicle-grid-item",maxWait:1e4,onFound:function(l){o("Ecommerce: view_item_list ("+l.length+" vehicles)"),u({event:"view_item_list",item_list_id:"vehicles",item_list_name:"Available Vehicles",items:N(),form_data:b()})},onTimeout:function(){o("Ecommerce: view_item_list skipped (validation failed or timeout)")}}));var a=i.closest("#step2RateSection .vehicle-grid-item-btn-holder button");if(a&&!i.closest("#showRatesBtn")){o("Ecommerce: select_item");var c=W(a);u(Object.assign({event:"select_item"},c))}var s=i.closest('#step3LoginForm button[type="submit"], #ContinueAsGuest, #btnContinueAsGuest');if(s||i.tagName==="BUTTON"&&i.textContent.toLowerCase().includes("continue as guest")){o("Ecommerce: begin_checkout");var d=q();w(function(l){var O=Object.assign({event:"begin_checkout",form_data:b()},d);l&&(O.user_data=l,o("Enhanced Conversions: user_data attached")),u(O)})}},!0),document.addEventListener("change",function(n){if(n.target.matches("#PaymentTypeId")){o("Ecommerce: add_payment_info");var i=n.target.options[n.target.selectedIndex],a=i&&i.text||"unknown",c=q();w(function(s){var d=Object.assign({event:"add_payment_info",payment_type:a,form_data:b()},c);s&&(d.user_data=s),u(d)})}},!0);var e="#PickUpDate, #PickUpTime, #PickupLocation, #DropoffLocation, #ServiceTypeId, #Passengers, #Luggage";function t(n){F||(F=!0,o("Form: form_start triggered by",n),u({event:"form_start",form_id:"booking_form",form_name:"Limo Booking Form",form_destination:window.location.href,first_field:n}))}document.addEventListener("focus",function(n){n.target.matches&&n.target.matches(e)&&t(n.target.id||n.target.name||"unknown")},!0),document.addEventListener("click",function(n){var i=n.target;if(i.matches&&(i.matches(e)||i.closest(".datepickerbutton, .timepicker"))){var a=i.closest(e)||i;t(a.id||a.name||"booking_field")}},!0),document.addEventListener("change",function(n){n.target.matches("#ServiceTypeId")&&t("ServiceTypeId")},!0);var r="#Passenger_Email, #Passenger_Phone, #Passenger_Phone_View";document.addEventListener("blur",function(n){n.target.matches&&n.target.matches(r)&&setTimeout(k,100)},!0),document.addEventListener("change",function(n){n.target.matches&&n.target.matches("#Passenger_Email")&&setTimeout(k,100)},!0),o("Ecommerce listeners installed")}function $(){if(o("Initializing session:",m),!y()){o("Not in iframe, sender disabled");return}L(),M(),Y(),D(),E&&u({event:"la_bridge_init",la_session_id:m,la_widget_url:window.location.href,_debug_only:!0}),o("Sender initialized")}$()})();
